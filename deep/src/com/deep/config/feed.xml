<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
			
<mapper namespace="feed">
	<!-- Insert -->
	<select id="addFeed" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed(deepMemberNo, deepCategoryNo, deepFeedStatus, deepFeedType, deepFeedCreateDate, deepFeedTitle, deepFeedImages, deepFeedContent)
		VALUES(#{memberNo}. #{categoryNo}, #{feedStatus}, #{feedType}, #{inputCurrentDate}, #{feedTitle}, #{feedIamges}, #{feedContent})
	</select>	

	<select id="addFeedReady" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_ready(deepMemberNo, deepCategoryNo, deepFeedStatus, deepFeedType, deepFeedCreateDate, deepFeedTitle, deepFeedImages, deepFeedContent)
		VALUES(#{memberNo}. #{categoryNo}, #{feedStatus}, #{feedType}, #{inputCurrentDate}, #{feedTitle}, #{feedIamges}, #{feedContent})
	</select>	

	<select id="addFeedSeries" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_series(deepFeedNo, deepMemberNo, deepFeedSeriesStatus, deepFeedSeriesId, deepFeedSeriesOrder, deepFeedSeriesCreateDate, deepFeedSeriesName)
		VALUES(#{feedNo}. #{memberNo}, #{feedStatus}, #{feedSeriesId}, #{feedSeriesOrder}, #{inputCurrentDate}, #{feedSeriesName})
	</select>	
	
	<select id="addFeedSeriesReady" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_series_ready(deepFeedNo, deepMemberNo, deepFeedSeriesStatus, deepFeedSeriesId, deepFeedSeriesOrder, deepFeedSeriesCreateDate, deepFeedSeriesName)
		VALUES(#{feedNo}. #{memberNo}, #{feedStatus}, #{feedSeriesId}, #{feedSeriesOrder}, #{inputCurrentDate}, #{feedSeriesName})
	</select>	

	<select id="addFeedComment" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_comment(deepFeedNo, deepMemberNo, deepFeedCommentStatus, deepFeedParentCommentNo, deepFeedCommentDepth, deepFeedCommentNotify, , deepFeedCommentCreateDate, deepFeedCommentContent)
		VALUES(#{feedNo}. #{memberNo}, #{feedCommentStatus}, #{feedParentCommentNo}, #{feedCommentDepth}, #{feddCommentNotify}, #{inputCurrentDate}, #{feedCommentContent})
	</select>	
	
	<select id="addFeedLike" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_like(deepFeedNo, deepMemberNo, deepFeedLikeDate)
		VALUES(#{feedNo}. #{memberNo}, #{inputCurrentDate})
	</select>				
	
	<select id="addFeedCommentLike" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_comment_like(deepFeedCommentNo, deepMemberNo, deepFeedCommentLikeDate)
		VALUES(#{feedCommentNo}. #{memberNo}, #{inputCurrentDate})
	</select>				
	
	<select id="addFeedShare" parameterType="java.util.HashMap" resultType="int">
		INSERT INTO deep_feed_share(deepFeedNo, deepMemberNo, deepFeedShareDate)
		VALUES(#{feedCommentNo}. #{memberNo}, #{inputCurrentDate})
	</select>				
				
	<!-- Update -->
	<select id="setFeed" parameterType="java.util.HashMap" resultType="int">
		UPDATE deep_feed SET deepCategoryNo=#{categoryNo}, deepFeedStatus=#{feedStatus}, deepFeedType=#{feedType}, deepFeedUpdateDate=#{inputCurrentDate}, deepFeedTitle=#{feedTitle}, deepFeedImages=#{feedImages}, deepFeedContent=#{feedContent}
		WHERE deepFeedNo=#{feedNo} AND deepMemberNo=#{memberNo}
	</select>
	
	<!-- Delete -->
	<select id="deleteFeedLike" parameterType="java.util.HashMap" resultType="int">
		DELETE FROM deep_feed_like WHERE deepFeedNo=#{feedNo} AND deepMemberNo=#{memberNo}
	</select>
	
	<select id="deleteFeedCommentLike" parameterType="java.util.HashMap" resultType="int">
		DELETE FROM deep_feed_comment_like WHERE deepFeedCommentNo=#{feedCommentNo} AND deepMemberNo=#{memberNo}
	</select>
	
	<!-- Common -->
    <select id="getFeedList" parameterType="java.util.HashMap" resultType="com.deep.model.domain.FeedList">
		<if test="mode == 1" >
			SELECT *, 0 as rating FROM deep_feed WHERE deepFeedStatus=1 AND deepCategoryNo=#{categoryNo] AND deepFeedCreateDate <![CDATA[>]]> #{currentDate} - 60*60*24*31 ORDER BY deepFeedCreateDate DESC LIMIT #{inputParam}, 15
		</if>
		<if test="mode == 2">
			SELECT a.*, sum(a.rate) as rating
			FROM 
			(
				(SELECT df.* , 50 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as viewCount FROM deep_feed_view WHERE deepFeedViewDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfv 
				WHERE dfv.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfv.viewCount DESC)
				UNION
				(SELECT df.* , 30 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as shareCount FROM deep_feed_share WHERE deepFeedShareDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfs 
				WHERE dfs.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfs.shareCount DESC)
				UNION
				(SELECT df.* , 20 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as likeCount FROM deep_feed_like WHERE deepFeedLikeStatus=1 AND deepFeedLikeDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfl 
				WHERE dfl.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfl.likeCount DESC)
			) as a
			GROUP BY a.deepFeedNo
			ORDER BY rating DESC
		</if>
	</select>
	
	<select id="getFeedSeries" parameterType="int" resultType="com.deep.model.domain.FeedSeries">
		SELECT * FROM deep_feed_series WHERE deepFeedNo=#{inputFeedNo}
	</select>
	
	<select id="getFeedHashtag" parameterType="int" resultType="com.deep.model.domain.FeedHashtag">
		SELECT * FROM deep_feed_hashtag WHERE deepFeedNo=#{inputFeedNo}
	</select>
	
	<select id="getFeed" parameterType="int" resultType="com.deep.model.domain.Feed">
		SELECT * FROM deep_feed WHERE deepFeedNo=#{inputFeedNo}
	</select>
	
	<select id="getFeedReady" parameterType="int" resultType="com.deep.model.domain.Feed">
		SELECT * FROM deep_feed_ready WHERE deepFeedNo=#{inputFeedNo}
	</select>
		
	<select id="searchFeed" parameterType="java.util.HashMap" resultType="com.deep.model.domain.Feed">
		
	</select>
	
	<select id="getFeedLastOne" parameterType="int" resultType="int">
		SELECT deepFeedNo FROM deep_feed WHERE deepMemberNo=#{inputMemberNo} ORDER BY deepFeedCreateDate DESC LIMIT 1
	</select>
	
	<select id="getFeedReadyLastOne" parameterType="int" resultType="int">
		SELECT deepFeedNo FROM deep_feed_ready WHERE deepMemberNo=#{inputMemberNo} ORDER BY deepFeedCreateDate DESC LIMIT 1
	</select>
		
	<select id="getFeedReadyList" parameterType="java.util.HashMap" resultType="com.deep.model.domain.Feed">
		SELECT * FROM deep_feed_ready WHERE deepMemberNo=#{memberNo} AND deepFeedCreateDate <![CDATA[>]]> #{inputCurrentDate}-60*60*24*7 ORDER BY deepFeedCreateDate DESC
	</select>
	
	<select id="getFeedCount" parameterType="int" resultType="com.deep.model.domain.FeedCount">
		SELECT (SELECT count(*) FROM deep_feed_like WHERE deepFeedNo=#{inputFeedNo} AND deepFeedLikeStatus=1) as deepLikdeCount,
				 (SELECT count(*) FROM deep_feed_comment WHERE deepFeedNo=#{inputFeedNo} AND deepFeedCommentStatus=1) as deepCommentCount, 
				 (SELECT count(*) FROM deep_feed_share WHERE deepFeedNo=#{inputFeedNo}) as deepShareCount
	</select>
	
	<select id="getFeedCommentList" parameterType="int" resultType="com.deep.model.domain.FeedComment">
		SELECT * FROM deep_feed_comment WHERE deepFeedNo=#{inputFeedNo} AND deepFeedCommentStatus=1
	</select>
	
	<select id="checkFeedLike" parameterType="java.util.HashMap" resultType="int">
		SELECT * FROM deep_feed_like WHERE deepFeedNo=#{inputFeedNo} AND deepMemberNo=#{memberNo}
	</select>	
		
	<select id="checkFeedCommentLike" parameterType="java.util.HashMap" resultType="int">
		SELECT * FROM deep_feed_comment_like WHERE deepFeedCommentNo=#{inputFeedCommentNo} AND deepMemberNo=#{memberNo}
	</select>	
	
	<select id="checkFeedShare" parameterType="java.util.HashMap" resultType="int">
		SELECT * FROM deep_feed_share WHERE deepFeedNo=#{inputFeedNo} AND deepMemberNo=#{memberNo}
	</select>				
		
	<select id="countFeedCommentLike" parameterType="java.util.HashMap" resultType="int">
		SELECT count(*) FROM deep_feed_comment_like WHERE deepFeedCommentNo=#{inputFeedCommentNo}
	</select>
</mapper>