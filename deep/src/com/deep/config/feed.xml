<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
			
<mapper namespace="feed">

	<!-- Common -->
    <select id="getFeedList" parameterType="java.util.HashMap" resultType="com.deep.model.domain.FeedList">
		<if test="mode == 1" >
			SELECT * FROM deep_feed WHERE deepFeedStatus=1 AND deepCategoryNo=#{categoryNo] AND deepFeedCreateDate <![CDATA[>]]> #{currentDate} - 60*60*24*31 ORDER BY deepFeedCreateDate DESC LIMIT #{inputParam}, 15
		</if>
		<if test="mode == 2">
			SELECT a.*, sum(a.rate) as rating
			FROM 
			(
				(SELECT df.* , 50 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as viewCount FROM deep_feed_view WHERE deepFeedViewDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfv 
				WHERE dfv.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfv.viewCount DESC)
				UNION
				(SELECT df.* , 30 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as shareCount FROM deep_feed_share WHERE deepFeedShareDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfs 
				WHERE dfs.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfs.shareCount DESC)
				UNION
				(SELECT df.* , 20 as rate FROM deep_feed df, (SELECT * , count(deepFeedNo) as likeCount FROM deep_feed_like WHERE deepFeedLikeStatus=1 AND deepFeedLikeDate <![CDATA[>]]> #{currentDate} - 60*60*24*14 GROUP BY deepFeedNo) dfl 
				WHERE dfl.deepFeedNo=df.deepFeedNo AND df.deepFeedStatus=1 ORDER BY dfl.likeCount DESC)
			) as a
			GROUP BY a.deepFeedNo
			ORDER BY rating DESC
		</if>
	</select>
	
	<select id="getFeedSeries" parameterType="int" resultType="com.deep.model.domain.FeedSeries">
		SELECT * FROM deep_feed_series WHERE deepFeedNo=#{inputDeepFeedNo}
	</select>
	
	<select id="getFeedHashtag" parameterType="int" resultType="com.deep.model.domain.FeedHashtag">
		SELECT * FROM deep_feed_hashtag WHERE deepFeedNo=#{inputDeepFeedNo}
	</select>
</mapper>